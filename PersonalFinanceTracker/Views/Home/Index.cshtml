@* Views/Home/Index.cshtml *@
@{
    ViewData["Title"] = "Login / Register";
}

<div class="row mt-5">
    <div class="col-md-6">
        <h2>Register</h2>
        <form id="registerForm">
            <div class="mb-3">
                <label for="regEmail" class="form-label">Email</label>
                <input type="email" class="form-control" id="regEmail" required>
            </div>
            <div class="mb-3">
                <label for="regFirstName" class="form-label">First Name</label>
                <input type="text" class="form-control" id="regFirstName" required>
            </div>
            <div class="mb-3">
                <label for="regPassword" class="form-label">Password</label>
                <input type="password" class="form-control" id="regPassword" required>
            </div>
            <div class="mb-3">
                <label for="regConfirmPassword" class="form-label">Confirm Password</label>
                <input type="password" class="form-control" id="regConfirmPassword" required>
            </div>
            <button type="submit" class="btn btn-primary">Register</button>
        </form>
    </div>

    <div class="col-md-6">
        <h2>Login</h2>
        <form id="loginForm">
            <div class="mb-3">
                <label for="loginEmail" class="form-label">Email</label>
                <input type="email" class="form-control" id="loginEmail" required>
            </div>
            <div class="mb-3">
                <label for="loginPassword" class="form-label">Password</label>
                <input type="password" class="form-control" id="loginPassword" required>
            </div>
            <button type="submit" class="btn btn-success">Login</button>
        </form>
        <p id="authStatus" class="mt-3"></p>
    </div>
</div>

@section Scripts {
    <script>
        // --- Event Listeners for Forms ---
        document.getElementById('registerForm').addEventListener('submit', function(e) {
            e.preventDefault();
            handleRegister();
        });

        document.getElementById('loginForm').addEventListener('submit', function(e) {
            e.preventDefault();
            handleLogin();
        });

        // --- Core API Interaction Functions ---

        async function handleRegister() {
            const email = document.getElementById('regEmail').value;
            const firstName = document.getElementById('regFirstName').value;
            const password = document.getElementById('regPassword').value;
            const confirmPassword = document.getElementById('regConfirmPassword').value;

            const response = await fetch('/api/Auth/Register', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ email, firstName, password, confirmPassword, lastName: "Demo" })
            });

            const data = await response.json();
            const status = document.getElementById('authStatus');

            if (response.ok && data.isSuccess) {
                status.textContent = 'Registration successful! Please log in.';
                status.className = 'text-success';
                document.getElementById('loginEmail').value = email; // Pre-fill login
            } else {
                status.textContent = 'Registration failed: ' + (data.errors ? data.errors.join(', ') : response.statusText);
                status.className = 'text-danger';
            }
        }

        async function handleLogin() {
            // 1. Collect inputs
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;

            // 2. API Call
            const response = await fetch('/api/Auth/Login', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ email, password })
            });

            const data = await response.json();
            const status = document.getElementById('authStatus');

            // 3. Success Check
            if (response.ok && data.isSuccess && data.token) { // CRITICAL: Check for data.token

                // **GUARANTEED EXECUTION BLOCK**
                localStorage.setItem('authToken', data.token); // Store token
                status.textContent = `Login successful! Redirecting...`; // Update status message
                status.className = 'text-success';

                // Redirect with a slight delay to allow status update
                setTimeout(() => {
                    window.location.href = '/Home/Dashboard';
                }, 100);

            } else {
                // 4. Failure Block
                status.textContent = 'Login failed. Check credentials.';
                status.className = 'text-danger';
                console.error('Login Failed:', data); // Log the full API response for inspection
            }
        }
    </script>
}